参考文档：[https://docs.sonarqube.org/latest/instance-administration/security/](https://docs.sonarqube.org/latest/instance-administration/security/)
<a name="ubQQe"></a>
## 概述
SonarQube具有许多全局安全功能:

- 认证和授权机制
- 强制身份认证
- 委派认证

除此之外，还可在group/user级别配置:

- 查看一个已存在的项目
- 访问项目的源代码
- 管理一个项目（设置排除模式，调整该项目的插件配置等）
- 管理质量配置，质量阈，实例…

安全性的另一个方面是对密码等设置进行加密。SonarQube提供了一种内置的机制来加密设置。
<a name="es0Nn"></a>
## 认证
[https://docs.sonarsource.com/sonarqube/latest/instance-administration/security/#authentication](https://docs.sonarsource.com/sonarqube/latest/instance-administration/security/#authentication)<br />匿名用户是否可以浏览SonarQube实例？当然不行！那就需要强制用户认证。<br />![image.png](https://cdn.nlark.com/yuque/0/2023/png/5374140/1695519452587-c8881154-efcf-4789-abcc-e58d974b285b.png#averageHue=%23f0f0f0&clientId=u02d9a59f-bae8-4&from=paste&height=186&id=u8b140b0b&originHeight=186&originWidth=444&originalType=binary&ratio=1&rotation=0&showTitle=false&size=14856&status=done&style=none&taskId=u6a5d5a9c-c33c-4780-b81f-6a294094746&title=&width=444)<br />强制用户身份验证可防止匿名用户通过Web API访问Sonar Qube UI或项目数据。一些特定的只读Web API，包括提示身份验证所需的API，仍然可以匿名使用。<br />禁用此设置可能会使实例面临安全风险。
<a name="i391m"></a>
### 认证机制
可通过多种方式来管理认证机制:

- 通过SonarQube內建的user/group数据库
- 通过外部程序(如LDAP)
- 通过HTTP headers
<a name="kIJd9"></a>
### Sonar用户
当你在SonarQube数据库中创建用户时，他将被视为本地用户，并且针对SonarQube自己的user/group数据库进行身份认证，而不是通过任何外部工具。<br />默认情况下，admin是本地账户。<br />同样，所有非本地(non-local)账户将仅针对外部工具进行身份认证。<br />管理员可以管理所有用户的**Tokens**——创建和删除。一旦创建，Token就是运行分析所需的唯一凭证，作为sonar.login属性的值来传递。<br />![image.png](https://cdn.nlark.com/yuque/0/2023/png/5374140/1695519931263-bdbaf5cf-2010-4c7e-8f67-89ea80ab9e45.png#averageHue=%23888888&clientId=u02d9a59f-bae8-4&from=paste&height=287&id=ub72ed404&originHeight=370&originWidth=1300&originalType=binary&ratio=1&rotation=0&showTitle=false&size=46701&status=done&style=none&taskId=ue64bcc75-92d9-4a70-b978-1535a815bea&title=&width=1008)
<a name="WAP9A"></a>
### [默认管理员凭据](https://docs.sonarsource.com/sonarqube/latest/instance-administration/security/#default-admin-credentials)
当安装SonarQube时，会自动创建具有管理系统权限的默认用户:` user: admin/passwd: admin`
<a name="vzVrD"></a>
### [**恢复管理员访问权限**](https://docs.sonarsource.com/sonarqube/latest/instance-administration/security/#reinstating-admin-access)
如果你修改了管理员密码，但又忘记了:
```sql
USE sonar;

update users set crypted_password ='$2a$12$uCkkXmhW5ThVK8mpBvnXOOJRLd64LJeHTeCkSuB3lfaR2N0AYBaSi',
salt=null, 
hash_method='BCRYPT'
where login ='admin'
```

如果您删除了管理员并随后锁定了具有全局管理权限的其他用户:
```sql
insert into user_roles(uuid, user_uuid, role)
values ('random-uuid', (select uuid from users where login='mylogin'), 'admin');
```
<a name="c3q4Q"></a>
## 授权
在SonarQube中实现授权的方式是非常标准的。可以根据需要创建任意数量的用户和用户组。然后，可以将用户附加到（或不附加）到（多个）组。然后向组和/或用户授予（多个）权限。这些权限授予对项目、服务和功能的访问权限。<br />对不同组、不同用于仅限权限分配，以访问不同的资源。

- **User**
- **Group**
- **Global Permissions**
   - Administer System
   - Administer Quality Profiles
   - Administer Quality Gates
   - Execute Analysis
   - Create Projects
   - Create Applications
   - Create Portfolios
- **Project Permissions**
   - Public and Private
      - Administer Issues
      - Administer Security Hotspots
      - Administer
      - Execute Analysis
   - Private
      - Browse
      - See Source Code

![image.png](https://cdn.nlark.com/yuque/0/2023/png/5374140/1695569225528-7645f311-7aee-4c68-8dff-529c9dbbad98.png#averageHue=%23f7f6f5&clientId=uba00b235-35a2-4&from=paste&height=165&id=u2731ecb8&originHeight=192&originWidth=1218&originalType=binary&ratio=1&rotation=0&showTitle=false&size=20816&status=done&style=none&taskId=u3820ba4a-a5d7-4e53-94f1-53c2e31066a&title=&width=1045)
<a name="ucJS9"></a>
### 相关配置
<a name="d4wcj"></a>
#### 强制要求必须登录SonarQube
用管理员账号登录SonarQube，打开Administration > Configuration > General Settings > Security，开启Force user authentication，点击Save保存生效。<br />开启该选项后，不允许匿名运行mvn sonar:sonar代码扫描，必须提供SonarQube Token。<br /> ![image.png](https://cdn.nlark.com/yuque/0/2023/png/5374140/1695525008836-f50f99d3-91a8-4d4c-93d6-0100b27660ee.png#averageHue=%23f4f4f4&clientId=u72bb6473-70ee-4&from=paste&height=220&id=u1a161e2e&originHeight=220&originWidth=681&originalType=binary&ratio=1&rotation=0&showTitle=false&size=19281&status=done&style=none&taskId=u778b7442-7004-4555-8a65-c8fc41adf3a&title=&width=681)
<a name="qkgbT"></a>
#### 修改默认的项目可见性为private
用管理员账号登录SonarQube，打开Administration > Projects > Management，修改Default visibility of new projects为private。<br />这样新建项目后，只有该项目的授权用户才能看到该项目的代码。<br />对已有的项目，打开项目级别的Adminstration > Permissions，手工修改项目可见性。<br />![image.png](https://cdn.nlark.com/yuque/0/2023/png/5374140/1695525054368-c9061380-0482-42c2-acd6-7bd535e71726.png#averageHue=%237b7b7b&clientId=u72bb6473-70ee-4&from=paste&height=295&id=uc28220c2&originHeight=408&originWidth=1306&originalType=binary&ratio=1&rotation=0&showTitle=false&size=46946&status=done&style=none&taskId=u5324f0b9-fe73-4498-8947-2a23d579aaf&title=&width=944)
<a name="xPGOR"></a>
#### 去掉Anyone组的权限
用管理员账号登录SonarQube，打开Administration > Security > Global Permissions，去掉Anyone组的所有权限。<br />**最新版本（v10.2.1.78527）AnyOne组已废弃**<br />![image.png](https://cdn.nlark.com/yuque/0/2023/png/5374140/1695525148798-7cae203a-26f3-43b6-88ad-4794598f02ee.png#averageHue=%23f5f5f5&clientId=u72bb6473-70ee-4&from=paste&height=225&id=u957531fa&originHeight=323&originWidth=1274&originalType=binary&ratio=1&rotation=0&showTitle=false&size=34296&status=done&style=none&taskId=u3a91a175-2695-4159-9f3d-95f14230c5f&title=&width=886)
<a name="ibHL5"></a>
#### 去掉Project Creator的权限
用管理员账号登录SonarQube，打开Administration > Security > Permission Templates，打开Default template，去掉Project Creator的所有权限。<br />![image.png](https://cdn.nlark.com/yuque/0/2023/png/5374140/1695525331905-5070d58e-9338-42a5-ad51-10b5840718bf.png#averageHue=%23f6f6f6&clientId=u72bb6473-70ee-4&from=paste&height=493&id=u19ee6701&originHeight=610&originWidth=1296&originalType=binary&ratio=1&rotation=0&showTitle=false&size=57544&status=done&style=none&taskId=u753c6d15-1765-4b37-b5db-4afaf5c7eda&title=&width=1047)
<a name="kgm0a"></a>
#### 生成用户Token
用该用户登录SonarQube，打开MyAccount > Security，来生成一个Token。<br />在按项目作多租户隔离的场景，需要为每个项目在SonarQube上创建一个用户，并使用该用户的Token来作代码扫描。<br />![image.png](https://cdn.nlark.com/yuque/0/2023/png/5374140/1695525450296-2fad4d38-f7b9-43d7-9273-f13380a36cfc.png#averageHue=%23f8f8f8&clientId=u72bb6473-70ee-4&from=paste&height=452&id=ub1ff166e&originHeight=519&originWidth=1006&originalType=binary&ratio=1&rotation=0&showTitle=false&size=46864&status=done&style=none&taskId=u6f7589e5-d2ab-4715-8373-d3fffac1d2e&title=&width=877)
<a name="OOyUn"></a>
#### 设置项目账号权限
用管理员账号登录SonarQube，打开项目级别的Adminstration > Permissions，选择Users，输入用户名称查询，然后设置该用户权限。<br />在按项目作多租户隔离的场景，需要为每个项目在SonarQube上创建一个用户，并设置只有该用户才有相应权限。<br />![image.png](https://cdn.nlark.com/yuque/0/2023/png/5374140/1695525888254-b1fb41a3-68eb-4ebb-b188-0754c057cd45.png#averageHue=%23f7f7f6&clientId=u72bb6473-70ee-4&from=paste&height=336&id=u7757e00b&originHeight=420&originWidth=1288&originalType=binary&ratio=1&rotation=0&showTitle=false&size=68430&status=done&style=none&taskId=u8ecff337-8e71-4cf2-91a2-54b04cb606c&title=&width=1030)
<a name="DBC0p"></a>
### 默认权限的权限模板
[https://docs.sonarsource.com/sonarqube/latest/instance-administration/security/#permission-templates-for-default-permissions](https://docs.sonarsource.com/sonarqube/latest/instance-administration/security/#permission-templates-for-default-permissions)<br />SonarQube附带默认权限模板，该模板在创建项目，项目组合或应用程序自动授予特定组的特定权限。管理员可以编辑此模板。<br />使用sonar扫描新项目后，如果要做角色管理，可以在sonarqube控制台为项目指定权限模板以分配角色权限，但是每次扫描新项目都通过手动添加，特别是项目多的情况下，显然是不方便的。<br />sonarqube在创建新权限模板的时候，提供了Project Key Pattern（项目标识模式）功能，可以通过其正则表达式将权限模板自动授予到project_key符合的项目<br />[![image.png](https://cdn.nlark.com/yuque/0/2022/png/5374140/1661001161605-c770342c-ff92-47a7-9a5c-645c106e5b79.png#averageHue=%23e5e5e4&clientId=u6f6b6c37-8bb1-4&from=paste&height=372&id=VMSxe&originHeight=548&originWidth=1410&originalType=url&ratio=1&rotation=0&showTitle=false&size=62051&status=done&style=none&taskId=ua6e7ab1b-e559-4d5c-b715-215fa0a8845&title=&width=957)](https://img2018.cnblogs.com/blog/686418/201905/686418-20190516171014571-288569112.png)

1. **选择“配置-权限-权限模板”创建新模板**

![image.png](https://cdn.nlark.com/yuque/0/2022/png/5374140/1661001161598-e8606f24-63f6-4a73-b19e-17030dfc363d.png#averageHue=%23e6e5e4&clientId=u6f6b6c37-8bb1-4&from=paste&height=290&id=Bklj2&originHeight=434&originWidth=1351&originalType=url&ratio=1&rotation=0&showTitle=false&size=60148&status=done&style=none&taskId=udeb4c664-3e89-4ae0-a0d7-e6202ec5950&title=&width=903)

2. **设置名称、描述、项目标识模式（使用sonarqube的正则表达式）**

.* 表示匹配0到多个字符（ps：这里与常见的正则表达式的模糊匹配（*）方式不同，[a,b] 匹配域内任意字符,<br />如：
```
.*test.* 可以匹配project key为：citestpipe，ci-test-pipe等形式的项目
.*[-,_]test.* 可以匹配project key为：ci-test-pipe，ci_test等形式的项目
```
use the "Create" button on **Administration** > **Security** > Permission Templates. It is possible to provide a **Project key pattern**.<br />![image.png](https://cdn.nlark.com/yuque/0/2023/png/5374140/1695569729638-670949e7-ab9a-44d0-9c5a-2d21cfa82814.png#averageHue=%23ececeb&clientId=uba00b235-35a2-4&from=paste&height=318&id=ue8454e2d&originHeight=318&originWidth=547&originalType=binary&ratio=1&rotation=0&showTitle=false&size=23676&status=done&style=none&taskId=u55706241-db8c-4d0d-a7fe-c23e3d8e7fe&title=&width=547)<br />**特别注意：**

1. 先要配置好permission template, 设置哪些组可以有哪些权限，比如设置组 ABC可以访问所有ABC 为前缀的项目。 
2. 然后进行代码扫描，生成的项目名称必须匹配 ABC 前缀
3. 最后，组ABC 的成员才能访问  ABC 前缀的扫描项目，因为提前已经建立了权限绑定关系。

如果之前没有进行这样的设置，过去创建的扫描项目不会默认继承这样的关系，必须重新手动进行授权。<br />![image.png](https://cdn.nlark.com/yuque/0/2023/png/5374140/1695570099424-125b0152-eca1-407c-b9a7-10c08a0775ac.png#averageHue=%23f4f4f4&clientId=uba00b235-35a2-4&from=paste&height=266&id=uddc5f499&originHeight=324&originWidth=1319&originalType=binary&ratio=1&rotation=0&showTitle=false&size=48358&status=done&style=none&taskId=u9ee5b8c5-a0ed-4450-b516-e8e1018e71b&title=&width=1082)<br />**官方解释：**<br />**虽然模板可以在项目创建后应用，但将包含 Creators 权限的模板应用于现有项目/项目组合/应用程序不会向项目的原始创建者授予相关权限，因为该关联未存储。**<br />请注意，项目和权限模板之间没有关系，这意味着：

- 将权限模板应用于项目后，可以修改项目的权限。
- 修改权限模板时，不会更改任何项目权限。

**3. 为模板设置用户/用户组的角色权限**<br />![image.png](https://cdn.nlark.com/yuque/0/2023/png/5374140/1695569617032-5cf921ad-6116-4657-ab1a-154915de5d15.png#averageHue=%23f6f6f6&clientId=uba00b235-35a2-4&from=paste&height=253&id=ude8139af&originHeight=314&originWidth=1285&originalType=binary&ratio=1&rotation=0&showTitle=false&size=28820&status=done&style=none&taskId=u11547cfa-ac0f-440d-9f3b-aa2e1382d77&title=&width=1036)

4. **设置完成，看到权限模板里已经有了新模板**

![image.png](https://cdn.nlark.com/yuque/0/2023/png/5374140/1695569682701-1bfbceda-52e2-4314-be46-5cf510029132.png#averageHue=%23f8f7f7&clientId=uba00b235-35a2-4&from=paste&height=200&id=u29692bc6&originHeight=200&originWidth=1062&originalType=binary&ratio=1&rotation=0&showTitle=false&size=38543&status=done&style=none&taskId=u776f0979-101a-4482-971d-3e1d12c2abb&title=&width=1062)

权限模板设置完成后，新扫描的项目，只要project key匹配正则规则的，就会自动分配角色权限了，不需要再手动通过“**配置-项目-项目管理**”设置了<br />![image.png](https://cdn.nlark.com/yuque/0/2023/png/5374140/1695570282206-d3a868d8-bfdd-4703-ba76-8fd6155edac3.png#averageHue=%23e4e3e3&clientId=uba00b235-35a2-4&from=paste&height=311&id=u7091fa48&originHeight=311&originWidth=1014&originalType=binary&ratio=1&rotation=0&showTitle=false&size=67795&status=done&style=none&taskId=u1202738b-498d-4bc4-a014-63f543526bf&title=&width=1014)


